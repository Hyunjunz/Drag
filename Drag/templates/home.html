<!DOCTYPE html>
<html lang="ko">

<head>
  <!--TODO: SHIT-->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <meta name="csrf-token" content="{{ csrf_token }}">

  <meta name="csrf-token" content="{{ csrf_token }}">
  <script>
    function setupCSRF() {
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      $.ajaxSetup({
        headers: {
          'X-CSRFToken': csrfToken
        }
      });
    }

    // ëª¨ë“  AJAX ìš”ì²­ ì „ì— í˜¸ì¶œ
    setupCSRF();
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drag - ì±„íŒ…</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bagel+Fat+One&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <meta name="username" content="{{ username }}">

  <style>
    
    
  </style>
  <script>
    function openProfile() {
      window.open("/profile");
    }
  </script>
</head>

<body>
  <div class="app-container">
    <div class="sidebar">
      <h2>DRAG</h2>
      <ul>
        <li class="active"><i class="fas fa-comments"></i><br>ì±„íŒ…</li>
        <li onclick="window.location.href = '/fd'"><i class="fas fa-user-friends"></i><br>ì¹œêµ¬</li>
        <li><i class="fas fa-bell"></i><br>ì•Œë¦¼</li>
        <li><i class="fas fa-cog"></i><br>ì„¤ì •</li>
      </ul>
    </div>

    <!-- ì±„íŒ… ëª©ë¡ -->
    <div class="friends-menu">
      <div class="friends-header">

        <h3>ì±„íŒ…ë°©</h3>
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="friend-search" placeholder="ì±„íŒ…ë°© ê²€ìƒ‰">
        </div>
        <!-- ëª¨ë‹¬ ì—´ê¸° ë²„íŠ¼ -->
        <button type="button" class="friend-tab" data-bs-toggle="modal" data-bs-target="#newChatModal"
          style="border-color: #0000;">
          ìƒˆ ì±„íŒ… ë§Œë“¤ê¸°
        </button>

        <div class="friend-tabs">
          <div class="friend-tab active">ì „ì²´ ì±„íŒ…</div>
          <div class="friend-tab">ê·¸ë£¹</div>
          <div class="friend-tab">DM</div>
        </div>
      </div>
      <div class="friends-list">
        <!-- ê·¸ë£¹ ì±„íŒ… í‘œì‹œ -->
        <div class="friend-category">
          ê·¸ë£¹ - {{ chats | selectattr('is_private') | list | length }}
        </div>
        {% for chat in chats if chat.is_private %}
        <div class="menu-item {% if selected_chat and selected_chat.id == chat.id %}active{% endif %}"
          onclick="window.location.href='{{ url_for('home') }}?chat_id={{ chat.id }}'">
          {{ chat.name }}
          <i class="fas fa-lock"></i>
        </div>
        {% endfor %}

        <!-- ë¹„ê³µê°œê°€ ì•„ë‹Œ ì±„íŒ… (DM ë“±) -->
        <div class="friend-category">
          ê¸°íƒ€ - {{ chats | rejectattr('is_private') | list | length }}
        </div>
        {% for chat in chats if not chat.is_private %}
        <div class="menu-item {% if selected_chat and selected_chat.id == chat.id %}active{% endif %}"
          onclick="window.location.href='{{ url_for('home') }}?chat_id={{ chat.id }}'">
          {{ chat.name }}
        </div>
        {% endfor %}
      </div>
    </div>



    <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
    <div class="main-content">
      <div class="topbar">
        <div class="title"><span>DRAG</span></div>
        <div class="profile-area">
          <div class="profile-name">
            <button onclick="openProfile()">{{ username }}</button>
          </div>
          <button class="settings-button">
            <i class="fas fa-cog"></i>
          </button>
          <button class="logout" onclick="logout()">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </div>
      <script>
        function logout() {
          fetch('/logout', {
            method: 'GET',
            credentials: 'same-origin'  // ì¿ í‚¤ ì„¸ì…˜ ìœ ì§€ìš©
          })
            .then(response => {
              if (response.redirected) {
                window.location.href = response.url; // ì„œë²„ê°€ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•˜ë©´ ë”°ë¼ê°
              } else {
                // í•„ìš”ì‹œ ë‹¤ë¥¸ ì²˜ë¦¬
                alert('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì™„ë£Œ');
              }
            })
            .catch(err => {
              console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', err);
            });
        }
      </script>
      <!-- ì„ íƒëœ ì±„íŒ…ë°©ì´ ìˆì„ ê²½ìš° -->
      {% if selected_chat %}
      <div class="chat-container">
        <div class="chat-header">
          <h4>{{ selected_chat.name }}</h4>
          {% if is_admin %}
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addMemberModal">
            <i class="fas fa-user-plus"></i> ë©¤ë²„ ì¶”ê°€
          </button>
          {% endif %}
        </div>

        <!-- ë©¤ë²„ ëª©ë¡ (ë¹„ê³µê°œ ì±„íŒ…ë°©ë§Œ í‘œì‹œ) -->
        {% if selected_chat.is_private %}
        <div class="member-list-toggle">
          <button id="toggleMemberBtn" class="btn btn-outline-secondary" type="button" onclick="toggleMemberList()">
            ë©¤ë²„ ëª©ë¡ ë³´ê¸°
          </button>

          <div id="memberListContainer" class="member-list" style="display: none;">
            <h5>ë©¤ë²„ ëª©ë¡</h5>
            <ul>
              {% for member in selected_chat.members %}
              <li>
                {{ member.username }}
                {% if member.id == selected_chat.creator_id %} (ìƒì„±ì){% endif %}
                {% if is_admin and member.username != username %}
                <button class="btn btn-sm btn-danger" onclick="removeMember({{ member.id }})">ì œê±°</button>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMemberModal">
              ë©¤ë²„ ì¶”ê°€í•˜ê¸°
            </button>
          </div>
        </div>
        {% endif %}

        <script>
          function toggleMemberList() {
            const list = document.getElementById('memberListContainer');
            const btn = document.getElementById('toggleMemberBtn');
            const isVisible = list.style.display === 'block';

            list.style.display = isVisible ? 'none' : 'block';
            btn.textContent = isVisible ? 'ë©¤ë²„ ëª©ë¡ ë³´ê¸°' : 'ë©¤ë²„ ëª©ë¡ ë‹«ê¸°';
          }
        </script>


        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div class="member-lists-container"></div>
        <div class="messages" id="chat-box">
          {% for message in messages %}
          <strong>{{ message.sender.username }}</strong> {{ message.content }}

          <small style="float: right;">{{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
        </div>
        {% else %}
        <p class="text-muted">ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
        {% endfor %}
      </div>


      <!-- ë©”ì‹œì§€ ì…ë ¥ í¼ -->
      <div class="chat-input">
        <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
        <button id="send-button">ì „ì†¡</button>
      </div>
    </div>
    {% else %}
    <div class="empty-chat">
      <h4>ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</h4>
      <p>ì™¼ìª½ì—ì„œ ê¸°ì¡´ ì±„íŒ…ë°©ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œìš´ ì±„íŒ…ë°©ì„ ìƒì„±í•˜ì„¸ìš”.</p>
    </div>
    {% endif %}
    </main>
  </div>
  </div>

  <!-- ìƒˆ ì±„íŒ…ë°© ìƒì„± ëª¨ë‹¬ -->
  <div class="modal fade" id="newChatModal" tabindex="-1" style="color: #303844;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ìƒˆ ì±„íŒ… ìƒì„±</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form action="{{ url_for('add_chat') }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <div class="modal-body">
            <div class="mb-3">
              <label for="chat_name" class="form-label">ì±„íŒ… ì´ë¦„</label>
              <input type="text" class="form-control" id="chat_name" name="chat_name" required>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="is_private" name="is_private">
              <label class="form-check-label" for="is_private">ë¹„ê³µê°œ ì±„íŒ…ë°©</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary">ìƒì„±</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ë©¤ë²„ ì¶”ê°€ ëª¨ë‹¬ -->
  <div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ë©¤ë²„ ì¶”ê°€</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="addMemberForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="new_member" class="form-label">ì‚¬ìš©ì ì´ë¦„</label>
              <input type="text" class="form-control" id="new_member" name="username" required>
              <script>
                document.addEventListener('DOMContentLoaded', function () {
                  const urlParams = new URLSearchParams(window.location.search);
                  const currentChatId = urlParams.get('chat_id');
                  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                  const addMemberForm = document.getElementById('addMemberForm');
                  const addMemberModalEl = document.getElementById('addMemberModal');
                  const addMemberModal = bootstrap.Modal.getOrCreateInstance(addMemberModalEl);

                  addMemberForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    if (!currentChatId) {
                      alert('í˜„ì¬ ì±„íŒ…ë°© IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                      return;
                    }

                    const formData = new FormData(addMemberForm);
                    const username = formData.get('username');
                    if (!username) return;

                    try {
                      const response = await fetch(`/chat/${currentChatId}/add_member`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                          'X-CSRFToken': csrfToken,
                          'X-Requested-With': 'XMLHttpRequest'
                        }
                      });

                      if (response.ok) {
                        addMemberModal.hide();
                        addMemberForm.reset();
                        alert('ë©¤ë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                      } else {
                        const errorText = await response.text();
                        alert('ë©¤ë²„ ì¶”ê°€ ì‹¤íŒ¨: ' + errorText);
                      }
                    } catch (error) {
                      console.error('ë©¤ë²„ ì¶”ê°€ ì—ëŸ¬:', error);
                      alert('ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                    addMemberModal.hide();

                    // ê°•ì œë¡œ body í´ë˜ìŠ¤ ì œê±°
                    document.body.classList.remove('modal-open');

                    // ë‚¨ì•„ìˆëŠ” ë°±ë“œë¡­ ì œê±°
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                      backdrop.parentNode.removeChild(backdrop);
                    }
                  });
                });


              </script>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      let currentChatId = null;
      let socket = null;
      let isTyping = false;
      let typingTimeout = null;

      function formatTime(time) {
        const date = new Date(time);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      function scrollToBottom() {
        const chatBox = document.getElementById('chat-box');
        if (!chatBox) return;
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function showEmptyChatState() {
        const chatBox = document.getElementById('chat-box');
        if (!chatBox) return;
        chatBox.innerHTML = '<p class="empty-message">ì±„íŒ… ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      }
      function showToast(message, type = 'info') {
        //alert(`${type.toUpperCase()}: ${message}`);
        //loadChatMessages(currentChatId);
      }


      function hideTypingIndicator() {
        const typingDiv = document.querySelector('.typing-indicator');
        if (typingDiv) {
          typingDiv.remove();
        }

        isTyping = false;
        if (typingTimeout) {
          clearTimeout(typingTimeout);
          typingTimeout = null;
        }
      }

      function getCurrentUsername() {
        const metaUsername = document.querySelector('meta[name="username"]')?.content;
        if (metaUsername) return metaUsername;

      }


      function loadInitialData() {
        console.log('Loading initial data...');
        const urlParams = new URLSearchParams(window.location.search);
        currentChatId = urlParams.get('chat_id');

        if (currentChatId) {
          joinChatRoom(currentChatId);
          loadChatMessages(currentChatId);
        } else {
          showEmptyChatState();
        }
      }

      function joinChatRoom(chatId) {
        console.log('Joining chat room:', chatId);
        if (socket && socket.connected) {
          socket.emit('join_chat', { chat_id: chatId });
        }
      }

      function loadChatMessages(chatId) {
        console.log('Loading messages for chat:', chatId);
        fetch(`/api/chat/${chatId}/messages`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            if (response.status === 403) { alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); throw new Error('Forbidden'); }
            return response.json();
          })
          .then(data => {
            const chatBox = document.getElementById('chat-box');
            if (!chatBox) return;

            chatBox.innerHTML = '';

            if (data.messages && data.messages.length > 0) {
              data.messages.forEach(msg => {
                addMessageToChat(msg.content, msg.sender, msg.timestamp, false);
              });
            } else {
              showEmptyChatState();
            }

          })
          .catch(error => {
            console.error('Error loading messages:', error);
            showToast('ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
          });
      }

      function setupEventListeners() {
        console.log('Setting up event listeners...');
        const sendButton = document.getElementById('send-button');
        const messageInput = document.getElementById('message-input');
        const chatItems = document.querySelectorAll('.chat-item');

        if (sendButton) {
          sendButton.addEventListener('click', sendMessage);
        }

        if (messageInput) {
          messageInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage();
            }
          });

          messageInput.addEventListener('input', function () {
            if (socket?.connected && currentChatId) {
              handleTyping();
            }
          });
        }

        if (chatItems) {
          chatItems.forEach(item => {
            item.addEventListener('click', function () {
              const chatId = this.dataset.chatId;
              changeChat(chatId);
            });
          });
        }

        window.addEventListener('popstate', function () {
          const urlParams = new URLSearchParams(window.location.search);
          const chatId = urlParams.get('chat_id');
          if (chatId) {
            changeChat(chatId);
          }
        });
      }

      function initializeSocket() {
        if (socket) {
          socket.disconnect();
        }

        socket = io.connect(window.location.origin, {
          reconnection: true,
          reconnectionAttempts: Infinity,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          transports: ['polling'],
          upgrade: false
        });

        socket.on('connect', function () {
          console.log('Socket connected:', socket.id);
          if (currentChatId) {
            socket.emit('join_chat', { chat_id: currentChatId });
          }
          loadInitialData();
        });

        socket.on('disconnect', function (reason) {
          console.log('Socket disconnected:', reason);
          if (reason === 'io server disconnect') {
            socket.connect();
          }
        });


        socket.on('new_message', function (data) {
          console.log("ğŸ“¥ new_message ìˆ˜ì‹ :", data);
          if (String(data.chat_id) === currentChatId) {
            addMessageToChat(data.message, data.sender, data.timestamp, false);
            //updateChatLastMessage(data.chat_id, data.message, data.timestamp);
            scrollToBottom()
          } else {
            showNewMessageNotification(data.chat_id, data.sender, data.message);
          }
        });

        socket.on('typing', function (data) {
          if (data.chat_id === currentChatId && data.sender !== getCurrentUsername()) {
            showTypingIndicator(data.sender);
          }
        });


        socket.on('stop_typing', function (data) {
          if (data.chat_id === currentChatId) {
            hideTypingIndicator();
          }
        });

        socket.on('chat_update', function (data) {
          if (data.chat_id === currentChatId) {
            refreshChatMessages();
          }
        });

        socket.on('error', function (err) {
          console.error('Socket error:', err);
          showToast('ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message, 'error');
        });

        socket.on('reconnect_attempt', () => {
          console.log('Reconnection attempt');
        });

        socket.on('reconnect', (attempt) => {
          console.log(`Reconnected after ${attempt} attempts`);
        });

        socket.on('reconnect_failed', () => {
          console.log('Reconnection failed');
          showToast('ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.', 'error');
        });
      }

      function showNewMessageNotification(chatId, sender, message) {
        const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
        if (chatItem) {
          chatItem.classList.add('new-message');

          let badge = chatItem.querySelector('.unread-badge');
          if (!badge) {
            badge = document.createElement('span');
            badge.className = 'unread-badge';
            chatItem.appendChild(badge);
          }

          if (Notification.permission === 'granted') {
            new Notification(`${sender}ë‹˜ì˜ ìƒˆ ë©”ì‹œì§€`, {
              body: message.length > 30 ? message.substring(0, 30) + '...' : message,
              icon: '/static/images/notification-icon.png'
            });
          }
        }
      }

      async function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();

        if (!message || !currentChatId) return;

        messageInput.value = '';
        hideTypingIndicator();

        const sendButton = document.getElementById('send-button');
        const originalText = sendButton.innerHTML;
        sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        sendButton.disabled = true;

        try {
          const tempId = 'temp-' + Date.now();
          addMessageToChat(message, getCurrentUsername(), new Date(), true, tempId);

          if (socket?.connected) {
            socket.emit('send_message', {
              message: message,
              chat_id: currentChatId,
              temp_id: tempId
            }, (response) => {
              if (response && response.success) {
                const tempMsg = document.querySelector(`[data-temp-id="${tempId}"]`);
                if (tempMsg) {
                  tempMsg.dataset.tempId = '';
                  tempMsg.dataset.messageId = response.message_id;

                }
              } else {
                const errorMsg = (response && response.error) ? response.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                const tempMsg = document.querySelector(`[data-temp-id="${tempId}"]`);
                if (tempMsg) tempMsg.remove();
                showToast('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + errorMsg, 'error');
              }
            });


          } else {

            const response = await fetch('/api/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
              },
              body: JSON.stringify({
                message: message,
                chat_id: currentChatId
              })
            });

            const data = await response.json();
            if (!data.success) {
              const tempMsg = document.querySelector(`[data-temp-id="${tempId}"]`);
              if (tempMsg) tempMsg.remove();
              throw new Error(data.error || 'ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
            }
          }
        } catch (error) {
          console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
          showToast('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        } finally {
          sendButton.innerHTML = originalText;
          sendButton.disabled = false;
        }
        scrollToBottom();
      }

      function addMessageToChat(content, sender, timestamp, isOwnMessage = false) {
        const chatBox = document.getElementById('chat-box');
        if (!chatBox) return;

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');

        if (sender === currentUsername) {
          messageDiv.classList.add('my-message');
        } else {
          messageDiv.classList.add('other-message');
        }

        messageDiv.innerHTML = `
            <strong>${sender}</strong> ${escapeHtml(content)}
            <div class="timestamp">${new Date(timestamp).toLocaleTimeString()}</div>
        `;
        chatBox.appendChild(messageDiv);
      }









      function formatMessageContent(message) {
        if (!message) return '';

        const urlRegex = /(\b(https?|ftp|file):\/\/[-\w+&@#/%?=~|!:,.;]*[-\w+&@#/%=~|])/ig;
        message = message.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');

        const emailRegex = /(\b[\w.-]+@[\w.-]+\.\w{2,}\b)/ig;
        message = message.replace(emailRegex, '<a href="mailto:$1">$1</a>');

        const emojiMap = {
          ':)': 'ğŸ˜Š',
          ':(': 'ğŸ˜',
          ':D': 'ğŸ˜ƒ',
          ':P': 'ğŸ˜›',
          ';)': 'ğŸ˜‰',
          '<3': 'â¤ï¸',
          ':O': 'ğŸ˜®'
        };

        Object.entries(emojiMap).forEach(([key, value]) => {
          const regex = new RegExp(escapeRegExp(key), 'g');
          message = message.replace(regex, value);
        });

        message = message.replace(/\n/g, '<br>');

        return message;
      }

      function handleTyping() {
        if (!socket || !socket.connected || !currentChatId) return;

        if (!isTyping) {
          isTyping = true;
          socket.emit('typing', { chat_id: currentChatId });
        }

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          isTyping = false;
          socket.emit('stop_typing', { chat_id: currentChatId });
        }, 2000);
      }

      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.content || '';
      } 

      initializeSocket();
      setupEventListeners();

      if (window.Notification && Notification.permission !== 'denied') {
        Notification.requestPermission();
      }

      const messageInput = document.getElementById('message-input');
      if (messageInput) {
        messageInput.focus();
      }
      scrollToBottom();
    });

  </script>
  <script>
    const currentUsername = "{{ username }}";
  </script>
  <script>
    if (window.innerWidth <= 768) {  // 768px ì´í•˜ë¥¼ ëª¨ë°”ì¼ë¡œ ê°„ì£¼
      window.location.href = "/moi";
    }
  </script>
</body>

</html>